<h1 class="display-4 pt-4 pb-4">Create new post</h1>

<div *ngIf="error">
  <div class="text-danger d-flex justify-content-center">
    <div>Error contacting server. Try refreshing the page.</div>
  </div>
  <div class="text-danger d-flex justify-content-center">
    <div>
      <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor"
           class="bi bi-cloud-slash-fill" viewBox="0 0 16 16">
        <path fill-rule="evenodd"
              d="M3.112 5.112a3.125 3.125 0 0 0-.17.613C1.266 6.095 0 7.555 0 9.318 0 11.366 1.708 13 3.781 13H11L3.112 5.112zm11.372 7.372L4.937 2.937A5.512 5.512 0 0 1 8 2c2.69 0 4.923 2 5.166 4.579C14.758 6.804 16 8.137 16 9.773a3.2 3.2 0 0 1-1.516 2.711zm-.838 1.87l-12-12 .708-.708 12 12-.707.707z"/>
      </svg>
    </div>
  </div>
</div>

<div class="alert alert-danger" role="alert" *ngIf="alert">
  {{alert}}
</div>

<form #newPostForm="ngForm" (ngSubmit)="onSubmit()" id="newPostForm">
  <div [hidden]="newPostForm.submitted && !working">
    <h6>Post type</h6>
    <div class="btn-group mb-3">
      <button type="button" class="btn btn-primary" disabled id="btn-text-post" (click)="setPostType('text')">Text
      </button>
      <button type="button" class="btn btn-outline-secondary" id="btn-img-post" (click)="setPostType('img')">Image
      </button>
      <button type="button" class="btn btn-outline-secondary" id="btn-link-post" (click)="setPostType('link')">Link
      </button>
    </div>
    <div class="form-group">
      <label for="title">Title</label>
      <input id="title" name="title" type="text" class="form-control" required [(ngModel)]="post.title"
             #title="ngModel" maxlength="150">
      <small class="form-text text-muted"
             *ngIf="!title.invalid || title.untouched">Required.</small>
      <div *ngIf="title.invalid && (title.dirty || title.touched)"
           class="invalid-feedback">

        <div *ngIf="title.errors.required">
          Every post needs a title.
        </div>
      </div>
    </div>

    <div class="form-group">
      <label for="description">Description</label>
      <textarea id="description" name="description" class="form-control" [required]="post.type === 'text'" minlength="3"
                onkeydown='this.style.height = "";this.style.height = this.scrollHeight + 3 + "px"'
                [(ngModel)]="post.description"
                #description="ngModel" maxlength="2000"></textarea>
      <small class="form-text text-muted"
             *ngIf="(!description.invalid || description.untouched ) && post.type === 'text'">Required.</small>
      <small class="form-text text-muted"
             *ngIf="(!description.invalid || description.untouched ) && post.type!=='text'">Optional.</small>
      <div *ngIf="description.invalid && (description.dirty || description.touched)"
           class="invalid-feedback">

        <div *ngIf="description.errors.required">
          Text posts require a description.
        </div>
        <div *ngIf="description.errors.minlength">
          This description seems a bit short.
        </div>
      </div>
    </div>
    <h6 *ngIf="post.type === 'img'">You can upload one to three pictures for an image post.</h6>
    <div *ngIf="post.type === 'img'" class="row">
      <div class="col-md-2">
        <ul>
          <li>PNG/JPEG only</li>
          <li>Max. 500 kb (per image)</li>
        </ul>
      </div>
      <div class="col-md-10 d-flex flex-wrap">
        <div class="form-group">
          <label for="image-1" class="text-muted">Image 1</label>
          <input type="file" class="form-control-file" id="image-1" name="imageOne" (change)="onFileChange($event)"
                 accept="image/jpeg,image/png">
          <small class="text-success"
                 *ngIf="postImages.imageOne.size <= 500000 && postImages.imageOne.size">
            {{postImages.imageOne?.size / 1024 | number: '1.0-0' }} kb
          </small>
          <small class="text-danger" *ngIf="postImages.imageOne.size > 500000">
            {{postImages.imageOne?.size / 1024 | number: '1.0-0' }} kb
          </small>
          <br>
          <small class="text-success"
                 *ngIf="postImages.imageOne.type.includes('png') || postImages.imageOne.type.includes('jpeg')">
            {{postImages.imageOne.type}}
          </small>
          <small class="text-danger"
                 *ngIf="!(postImages.imageOne.type.includes('png') || postImages.imageOne.type.includes('jpeg'))">
            {{postImages.imageOne.type}}
          </small>
        </div>
        <div class="form-group">
          <label for="image-2" class="text-muted">Image 2</label>
          <input type="file" class="form-control-file" id="image-2" name="imageTwo" (change)="onFileChange($event)"
                 accept="image/jpeg,image/png">
          <small class="text-success"
                 *ngIf="postImages.imageTwo.size <= 500000 && postImages.imageTwo.size">
            {{postImages.imageTwo?.size / 1024 | number: '1.0-0' }} kb
          </small>
          <small class="text-danger" *ngIf="postImages.imageTwo.size > 500000">
            {{postImages.imageTwo?.size / 1024 | number: '1.0-0' }} kb
          </small>
          <br>
          <small class="text-success"
                 *ngIf="postImages.imageTwo.type.includes('png') || postImages.imageTwo.type.includes('jpeg')">
            {{postImages.imageTwo.type}}
          </small>
          <small class="text-danger"
                 *ngIf="!(postImages.imageTwo.type.includes('png') || postImages.imageTwo.type.includes('jpeg'))">
            {{postImages.imageTwo.type}}
          </small>
        </div>
        <div class="form-group">
          <label for="image-3" class="text-muted">Image 3</label>
          <input type="file" class="form-control-file" id="image-3" name="imageThree" (change)="onFileChange($event)"
                 accept="image/jpeg,image/png">
          <small class="text-success"
                 *ngIf="postImages.imageThree.size <= 500000 && postImages.imageThree.size">
            {{postImages.imageThree?.size / 1024 | number: '1.0-0' }} kb
          </small>
          <small class="text-danger" *ngIf="postImages.imageThree.size > 500000">
            {{postImages.imageThree?.size / 1024 | number: '1.0-0' }} kb
          </small>
          <br>
          <small class="text-success"
                 *ngIf="postImages.imageThree.type.includes('png') || postImages.imageThree.type.includes('jpeg')">
            {{postImages.imageThree.type}}
          </small>
          <small class="text-danger"
                 *ngIf="!(postImages.imageThree.type.includes('png') || postImages.imageThree.type.includes('jpeg'))">
            {{postImages.imageThree.type}}
          </small>

        </div>

      </div>
    </div>

    <div *ngIf="post.type  === 'link'" class="mb-3">
      <label for="link">Link</label>
      <input id="link" name="link" type="text"
             pattern="(http(s)?:\/\/.)?(www\.)?[-a-zA-Z0-9@:%._\+~#=]{2,256}\.[a-z]{2,6}\b([-a-zA-Z0-9@:%_\+.~#?&//=]*)"
             class="form-control" required [(ngModel)]="post.link"
             #link="ngModel">
      <small class="form-text text-muted"
             *ngIf="!link.invalid || link.untouched">Required.</small>
      <div *ngIf="link.invalid && (link.dirty || link.touched)"
           class="invalid-feedback">
        <div *ngIf="link.errors.required">
          A link post requires a link.
        </div>
        <div *ngIf="link.errors.pattern">
          Enter a valid url.
        </div>
      </div>
    </div>

    <button type="submit" class="btn btn-success" [disabled]="newPostForm.invalid || filesInvalid || working">
      <span *ngIf="!working">Submit post</span>
      <span *ngIf="working">
        <span class="spinner-border">
        </span>
      </span>
    </button>

  </div>

  <div class="posted-message" *ngIf="newPostForm.submitted && successId !== '0'">
    <div class="alert alert-success" role="alert">
      Success! You can check out your post <a routerLink="../{{successId}}">here</a>.
    </div>
  </div>
</form>
